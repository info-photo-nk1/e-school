import React, { useState, useEffect } from 'react';
import { ChevronLeft, ChevronRight, Home, BookOpen } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { 
  EnhancedLesson, 
  UserLessonProgress, 
  SectionProgress, 
  ProgressUpdate,
  Achievement
} from '../../types/enhancedLesson';
import InteractiveSectionCard from './InteractiveSectionCard';
import ProgressTracker from './ProgressTracker';
import { useTranslation } from '../../hooks/useTranslation';

interface EnhancedLessonContentProps {
  lesson: EnhancedLesson;
  courseId: string;
  onProgressUpdate?: (progress: UserLessonProgress) => void;
  onComplete?: () => void;
}

const EnhancedLessonContent: React.FC<EnhancedLessonContentProps> = ({
  lesson,
  courseId,
  onProgressUpdate,
  onComplete
}) => {
  const navigate = useNavigate();
  const { t } = useTranslation();
  
  // „Éó„É≠„Ç∞„É¨„ÇπÁä∂ÊÖã„ÅÆÁÆ°ÁêÜ
  const [userProgress, setUserProgress] = useState<UserLessonProgress>({
    lessonId: lesson.id,
    userId: 'current-user', // ÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØË™çË®º„Ç∑„Çπ„ÉÜ„É†„Åã„ÇâÂèñÂæó
    sectionsProgress: lesson.sections.map(section => ({
      sectionId: section.id,
      completed: false,
      timeSpent: 0,
      interactionsCompleted: [],
      quizScores: {},
      lastAccessed: new Date()
    })),
    overallProgress: 0,
    timeSpent: 0,
    lastAccessed: new Date(),
    completed: false,
    achievements: []
  });

  const [currentSectionIndex, setCurrentSectionIndex] = useState(0);
  const [startTime] = useState(new Date());

  // „Çª„ÇØ„Ç∑„Éß„É≥ÂÆå‰∫ÜÊï∞„ÅÆË®àÁÆó
  const completedSections = userProgress.sectionsProgress.filter(sp => sp.completed).length;
  
  // ÊÆã„ÇäÊôÇÈñì„ÅÆË®àÁÆó
  const completedTime = userProgress.sectionsProgress
    .filter(sp => sp.completed)
    .reduce((acc, sp) => acc + lesson.sections.find(s => s.id === sp.sectionId)?.estimatedTime || 0, 0);
  const estimatedTimeRemaining = Math.max(0, lesson.totalEstimatedTime - completedTime);

  // „Çª„ÇØ„Ç∑„Éß„É≥„ÅåËß£Èô§„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
  const isSectionUnlocked = (index: number) => {
    if (index === 0) return true; // ÊúÄÂàù„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„ÅØÂ∏∏„Å´Ëß£Èô§
    return userProgress.sectionsProgress[index - 1]?.completed || false;
  };

  // „Éó„É≠„Ç∞„É¨„ÇπÊõ¥Êñ∞Âá¶ÁêÜ
  const handleProgressUpdate = (update: ProgressUpdate) => {
    setUserProgress(prev => {
      const newProgress = { ...prev };
      const sectionIndex = newProgress.sectionsProgress.findIndex(sp => sp.sectionId === update.sectionId);
      
      if (sectionIndex === -1) return prev;

      const sectionProgress = { ...newProgress.sectionsProgress[sectionIndex] };

      switch (update.type) {
        case 'section-start':
          sectionProgress.lastAccessed = update.timestamp;
          break;
          
        case 'time-update':
          sectionProgress.timeSpent = update.data.timeSpent;
          break;
          
        case 'interaction':
          if (!sectionProgress.interactionsCompleted.includes(update.data.interactionId)) {
            sectionProgress.interactionsCompleted.push(update.data.interactionId);
          }
          break;
          
        case 'quiz-complete':
          sectionProgress.quizScores[update.data.quizId] = update.data.score;
          break;
          
        case 'section-complete':
          sectionProgress.completed = true;
          sectionProgress.lastAccessed = update.timestamp;
          // ÈÅîÊàê„Éê„ÉÉ„Ç∏„ÅÆËøΩÂä†
          if (!newProgress.achievements.some(a => a.id === `section-${update.sectionId}`)) {
            const newAchievement: Achievement = {
              id: `section-${update.sectionId}`,
              type: 'completion',
              title: '„Çª„ÇØ„Ç∑„Éß„É≥ÂÆå‰∫Ü',
              description: `„Çª„ÇØ„Ç∑„Éß„É≥ "${lesson.sections[sectionIndex]?.title}" „ÇíÂÆå‰∫Ü„Åó„Åæ„Åó„Åü`,
              icon: 'üéØ',
              unlockedAt: update.timestamp,
              points: 10
            };
            newProgress.achievements.push(newAchievement);
          }
          break;
      }

      newProgress.sectionsProgress[sectionIndex] = sectionProgress;
      
      // ÂÖ®‰Ωì„Éó„É≠„Ç∞„É¨„Çπ„ÅÆÊõ¥Êñ∞
      const completedCount = newProgress.sectionsProgress.filter(sp => sp.completed).length;
      newProgress.overallProgress = (completedCount / lesson.sections.length) * 100;
      
      // ÂÖ®‰Ωì„ÅÆÂ≠¶ÁøíÊôÇÈñìÊõ¥Êñ∞
      newProgress.timeSpent = newProgress.sectionsProgress.reduce((acc, sp) => acc + sp.timeSpent, 0);
      
      // „É¨„ÉÉ„Çπ„É≥ÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ
      if (completedCount === lesson.sections.length && !newProgress.completed) {
        newProgress.completed = true;
        const completionAchievement: Achievement = {
          id: `lesson-${lesson.id}`,
          type: 'milestone',
          title: '„É¨„ÉÉ„Çπ„É≥ÂÆå‰∫Ü',
          description: `„É¨„ÉÉ„Çπ„É≥ "${lesson.title}" „ÇíÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ`,
          icon: 'üèÜ',
          unlockedAt: new Date(),
          points: 50
        };
        newProgress.achievements.push(completionAchievement);
        onComplete?.();
      }

      newProgress.lastAccessed = update.timestamp;
      
      // „Éó„É≠„Ç∞„É¨„ÇπÊõ¥Êñ∞„ÅÆ„Ç≥„Éº„É´„Éê„ÉÉ„ÇØÂÆüË°å
      onProgressUpdate?.(newProgress);
      
      return newProgress;
    });
  };

  // „Çª„ÇØ„Ç∑„Éß„É≥„Ç¢„ÇØ„ÉÜ„Ç£„Éô„Éº„Ç∑„Éß„É≥
  const handleSectionActivate = (sectionIndex: number) => {
    if (isSectionUnlocked(sectionIndex)) {
      setCurrentSectionIndex(sectionIndex);
      handleProgressUpdate({
        sectionId: lesson.sections[sectionIndex].id,
        type: 'section-start',
        data: {},
        timestamp: new Date()
      });
    }
  };

  // „Çª„ÇØ„Ç∑„Éß„É≥ÂÆå‰∫ÜÂá¶ÁêÜ
  const handleSectionComplete = (sectionIndex: number) => {
    handleProgressUpdate({
      sectionId: lesson.sections[sectionIndex].id,
      type: 'section-complete',
      data: {},
      timestamp: new Date()
    });
    
    // Ê¨°„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„Å´Ëá™ÂãïÈÄ≤Ë°å
    if (sectionIndex < lesson.sections.length - 1) {
      setTimeout(() => {
        setCurrentSectionIndex(sectionIndex + 1);
      }, 1000);
    }
  };

  // „Ç≠„Éº„Éú„Éº„Éâ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥
  useEffect(() => {
    const handleKeyPress = (e: KeyboardEvent) => {
      if (e.key === 'ArrowLeft' && currentSectionIndex > 0) {
        handleSectionActivate(currentSectionIndex - 1);
      } else if (e.key === 'ArrowRight' && currentSectionIndex < lesson.sections.length - 1) {
        handleSectionActivate(currentSectionIndex + 1);
      }
    };

    window.addEventListener('keydown', handleKeyPress);
    return () => window.removeEventListener('keydown', handleKeyPress);
  }, [currentSectionIndex, lesson.sections.length]);

  return (
    <div className="min-h-screen bg-gray-50">
      {/* „Éò„ÉÉ„ÉÄ„Éº */}
      <div className="bg-white border-b border-gray-200 sticky top-0 z-40">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center justify-between h-16">
            <div className="flex items-center space-x-4">
              <button
                onClick={() => navigate(`/courses/${courseId}`)}
                className="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100"
              >
                <ChevronLeft className="w-5 h-5" />
              </button>
              
              <div className="flex items-center space-x-2">
                <BookOpen className="w-5 h-5 text-blue-600" />
                <h1 className="text-lg font-semibold text-gray-900 truncate max-w-md">
                  {lesson.title}
                </h1>
              </div>
            </div>

            {/* „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éú„Çø„É≥ */}
            <div className="flex items-center space-x-2">
              <button
                onClick={() => currentSectionIndex > 0 && handleSectionActivate(currentSectionIndex - 1)}
                disabled={currentSectionIndex === 0}
                className="p-2 text-gray-400 hover:text-gray-600 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg hover:bg-gray-100"
              >
                <ChevronLeft className="w-4 h-4" />
              </button>
              
              <span className="text-sm text-gray-600 px-3">
                {currentSectionIndex + 1} / {lesson.sections.length}
              </span>
              
              <button
                onClick={() => currentSectionIndex < lesson.sections.length - 1 && handleSectionActivate(currentSectionIndex + 1)}
                disabled={currentSectionIndex === lesson.sections.length - 1}
                className="p-2 text-gray-400 hover:text-gray-600 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg hover:bg-gray-100"
              >
                <ChevronRight className="w-4 h-4" />
              </button>

              <button
                onClick={() => navigate('/')}
                className="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100"
              >
                <Home className="w-4 h-4" />
              </button>
            </div>
          </div>
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div className="grid grid-cols-1 lg:grid-cols-4 gap-8">
          {/* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ */}
          <div className="lg:col-span-3">
            <div className="space-y-6">
              {lesson.sections.map((section, index) => (
                <InteractiveSectionCard
                  key={section.id}
                  section={section}
                  progress={userProgress.sectionsProgress[index]}
                  isActive={index === currentSectionIndex}
                  isCompleted={userProgress.sectionsProgress[index]?.completed || false}
                  isUnlocked={isSectionUnlocked(index)}
                  onActivate={() => handleSectionActivate(index)}
                  onComplete={() => handleSectionComplete(index)}
                  onProgressUpdate={handleProgressUpdate}
                />
              ))}
            </div>

            {/* „É¨„ÉÉ„Çπ„É≥ÂÆå‰∫Ü„É°„ÉÉ„Çª„Éº„Ç∏ */}
            {userProgress.completed && (
              <div className="mt-8 p-6 bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 rounded-xl">
                <div className="text-center">
                  <div className="text-4xl mb-4">üéâ</div>
                  <h3 className="text-2xl font-bold text-green-900 mb-2">
                    „É¨„ÉÉ„Çπ„É≥ÂÆå‰∫ÜÔºÅ
                  </h3>
                  <p className="text-green-700 mb-4">
                    „Åô„Åπ„Å¶„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ„ÅäÁñ≤„ÇåÊßò„Åß„Åó„ÅüÔºÅ
                  </p>
                  <div className="flex justify-center space-x-4">
                    <button
                      onClick={() => navigate(`/courses/${courseId}`)}
                      className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                    >
                      „Ç≥„Éº„Çπ„Å´Êàª„Çã
                    </button>
                    <button
                      onClick={() => navigate('/courses')}
                      className="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
                    >
                      ‰ªñ„ÅÆ„Ç≥„Éº„Çπ„ÇíË¶ã„Çã
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* „Çµ„Ç§„Éâ„Éê„Éº */}
          <div className="lg:col-span-1">
            <ProgressTracker
              totalSections={lesson.sections.length}
              completedSections={completedSections}
              currentSection={currentSectionIndex}
              progress={userProgress}
              estimatedTimeRemaining={estimatedTimeRemaining}
              onSectionClick={handleSectionActivate}
            />
          </div>
        </div>
      </div>
    </div>
  );
};

export default EnhancedLessonContent;